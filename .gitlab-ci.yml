image: cirrusci/flutter:stable

stages:
  - build
  - release

variables:
  FLUTTER_VERSION: "3.19.0"

cache:
  paths:
    - .pub-cache/

before_script:
  - flutter pub get

# Build cho Windows
build_windows:
  stage: build
  script:
    - flutter config --enable-windows-desktop
    - flutter build windows --release
  artifacts:
    paths:
      - build/windows/runner/Release/
    expire_in: 1 week
  only:
    - main
    - tags
  tags:
    - windows

# Build cho macOS
build_macos:
  stage: build
  before_script:
    # Cài đặt Flutter
    - brew install flutter
    - export PATH="$PATH:$HOME/flutter/bin"
    # Kiểm tra và cấu hình Flutter
    - flutter doctor
    - flutter pub get
  script:
    - flutter config --enable-macos-desktop
    - flutter build macos --release
  artifacts:
    paths:
      - build/macos/Build/Products/Release/*.app
    expire_in: 1 week
  only:
    - main
    - tags
  tags:
    - macos

# Build cho Linux
build_linux:
  stage: build
  script:
    - flutter config --enable-linux-desktop
    - flutter build linux --release
  artifacts:
    paths:
      - build/linux/x64/release/bundle/
    expire_in: 1 week
  only:
    - main
    - tags
  tags:
    - linux

# Tạo release khi có tag
release:
  stage: release
  script:
    - echo "Creating release for version $CI_COMMIT_TAG"
    - apt-get update && apt-get install -y zip
    - mkdir -p releases
    - if [ -d "build/windows/runner/Release" ]; then cd build/windows/runner/Release && zip -r ../../../../releases/vtol_windows_$CI_COMMIT_TAG.zip . && cd -; fi
    - if [ -d "build/macos/Build/Products/Release" ]; then cd build/macos/Build/Products/Release && zip -r ../../../../../releases/vtol_macos_$CI_COMMIT_TAG.zip *.app && cd -; fi
    - if [ -d "build/linux/x64/release/bundle" ]; then cd build/linux/x64/release/bundle && zip -r ../../../../../releases/vtol_linux_$CI_COMMIT_TAG.zip . && cd -; fi
  artifacts:
    paths:
      - releases/*.zip
    expire_in: never
  only:
    - tags