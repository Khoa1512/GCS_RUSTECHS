stages:
  - build
  - release

variables:
  FLUTTER_VERSION: "3.19.0"

# Tuỳ chọn: cache pub-cache (nếu phù hợp môi trường của bạn)
cache:
  paths:
    - .pub-cache/

# ---------------- Windows ----------------
build_windows:
  stage: build
  tags: [windows]                    # runner Windows (shell/pwsh)
  before_script:
    # Fix lỗi TLS của Git for Windows (schannel) -> dùng OpenSSL
    - git config --global http.sslBackend "openssl"
    - git config --global http.sslCAInfo "C:/Program Files/Git/mingw64/ssl/certs/ca-bundle.crt"
    - git config --global http.version HTTP/1.1

    # Cho phép Git truy cập SDK Flutter nằm ở user khác (nếu cần)
    - git config --global --add safe.directory "C:/Users/Rustechz/flutter"

    # Flutter đã cài sẵn trên máy; nếu chưa có thì cài bằng winget:
    # - pwsh -c 'if (-not (Get-Command flutter -ErrorAction SilentlyContinue)) { winget install -e --id Google.Flutter }'

    - flutter --version
    - flutter config --enable-windows-desktop
    - flutter pub get
  script:
    - flutter build windows --release
  artifacts:
    paths:
      - build/windows/x64/runner/Release/
    expire_in: 1 week
  only:
    - main
    - tags

# ---------------- macOS ----------------
build_macos:
  stage: build
  tags: [macos]                      # runner macOS (shell)
  before_script:
    - brew update
    - brew install flutter || true   # nếu đã có sẽ skip
    - export PATH="$PATH:$HOME/flutter/bin"
    - flutter --version
    - flutter config --enable-macos-desktop
    - flutter pub get
  script:
    - flutter build macos --release
  artifacts:
    paths:
      - build/macos/Build/Products/Release/*.app
    expire_in: 1 week
  only:
    - main
    - tags

# ---------------- Linux ----------------
build_linux:
  stage: build
  tags: [linux]                      # runner Linux (nên dùng docker executor)
  image: cirrusci/flutter:stable
  before_script:
    - flutter --version
    - flutter config --enable-linux-desktop
    - flutter pub get
  script:
    - flutter build linux --release
  artifacts:
    paths:
      - build/linux/x64/release/bundle/
    expire_in: 1 week
  only:
    - main
    - tags

# ---------------- Release (chạy trên Linux) ----------------
release:
  stage: release
  tags: [linux]
  image: alpine:latest
  script:
    - apk add --no-cache zip
    - echo "Creating release for version $CI_COMMIT_TAG"
    - mkdir -p releases
    - if [ -d "build/windows/x64/runner/Release" ]; then cd build/windows/x64/runner/Release && zip -r ../../../../../releases/skylink_windows_$CI_COMMIT_TAG.zip . && cd -; fi
    - if [ -d "build/macos/Build/Products/Release" ]; then cd build/macos/Build/Products/Release && zip -r ../../../../../releases/vtol_macos_$CI_COMMIT_TAG.zip *.app && cd -; fi
    - if [ -d "build/linux/x64/release/bundle" ]; then cd build/linux/x64/release/bundle && zip -r ../../../../../releases/vtol_linux_$CI_COMMIT_TAG.zip . && cd -; fi
  artifacts:
    paths:
      - releases/*.zip
    expire_in: never
  only:
    - tags
